#!/usr/bin/bash

abspath() {
  if [[ -d "$1" ]]
  then
    pushd "$1" >/dev/null
    pwd
    popd >/dev/null
  elif [[ -e $1 ]]
  then
    pushd "$(dirname "$1")" >/dev/null
    echo "$(pwd)/$(basename "$1")"
    popd >/dev/null
  else
    echo "$1" does not exist! >&2
    return 127
  fi
}

FILE=$(abspath $(readlink -f $0))
ROOT=$(abspath "$(dirname $FILE)/..")

while [[ $# -gt 0 ]]; do
  case $1 in
    build)
      set -e

      docker build -t workstation_base:latest --build-arg USER=$(whoami) $ROOT/deploy/base
      docker build -t workstation_js:latest --build-arg USER=$(whoami) $ROOT/deploy/js
      docker build -t workstation_rust:latest --build-arg USER=$(whoami) $ROOT/deploy/rust
      docker build -t workstation_postgresql:latest --build-arg USER=$(whoami) $ROOT/deploy/postgresql
      docker build -t workstation_redis:latest --build-arg USER=$(whoami) $ROOT/deploy/redis

      shift;
      ;;
    shell)
      shift;

      if [ -d "$2" ]; then
        DIR=$(abspath "$2")
      else
        DIR=$(pwd)
      fi

      docker run --env-file $ROOT/deploy/env --network=workstation_default -v "$DIR:/src" -it workstation_$1:latest
      shift; shift;
      ;;
    up)
      set -e

      shift;

      docker-compose -p workstation -f $ROOT/deploy/docker-compose.yml up --build $@
      ;;
    *)
      echo "Unknown argument [$key]. Aborting."
      exit 1
      ;;
  esac
done
